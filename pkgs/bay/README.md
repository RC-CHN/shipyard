# Bay API Service

Bay APIæ˜¯Agent Sandboxçš„ä¸­å°æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†å’Œè°ƒåº¦Shipå®¹å™¨ç¯å¢ƒã€‚

## å®‰è£…å’Œè¿è¡Œ

### ä½¿ç”¨uvï¼ˆæ¨èï¼‰

1. å®‰è£…uvåŒ…ç®¡ç†å™¨ï¼š

```bash
pip install uv
```

2. å®‰è£…ä¾èµ–ï¼š

```bash
uv pip install -e .
```

3. å¤åˆ¶ç¯å¢ƒé…ç½®ï¼š

```bash
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œè®¾ç½®æ•°æ®åº“è¿æ¥ç­‰é…ç½®
```

4. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š

```bash
alembic upgrade head
```

5. å¯åŠ¨æœåŠ¡ï¼š

```bash
python run.py
```

### ä½¿ç”¨Docker Compose

**é‡è¦**: Bayç°åœ¨ä½¿ç”¨å®¿ä¸»æœºçš„Docker socketï¼Œè€Œä¸æ˜¯Docker-in-Dockeræ¨¡å¼ï¼Œè¿™æä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚

1. ç¡®ä¿å®¿ä¸»æœºä¸Šå·²ç»å®‰è£…äº†Dockerå¹¶ä¸”Docker daemonæ­£åœ¨è¿è¡Œã€‚

2. æ„å»ºShipé•œåƒï¼ˆåœ¨å®¿ä¸»æœºä¸Šï¼‰ï¼š

```bash
cd ../ship
docker build -t ship:latest .
cd ../bay
```

3. åˆ›å»ºDockerç½‘ç»œï¼ˆç”¨äºShipå®¹å™¨ï¼‰ï¼š

```bash
docker network create shipyard
```

4. å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼š

```bash
docker-compose up -d
```

## APIç«¯ç‚¹

### è®¤è¯

æ‰€æœ‰APIç«¯ç‚¹éƒ½éœ€è¦Bearer tokenè®¤è¯ï¼š

```
Authorization: Bearer <your-access-token>
```

### Shipç®¡ç†

- `POST /ship` - åˆ›å»ºæ–°çš„Shipç¯å¢ƒ
- `GET /ship/{ship_id}` - è·å–Shipä¿¡æ¯
- `DELETE /ship/{ship_id}` - åˆ é™¤Shipç¯å¢ƒ
- `POST /ship/{ship_id}/exec/{oper_endpoint}` - åœ¨Shipä¸­æ‰§è¡Œæ“ä½œ
- `GET /ship/logs/{ship_id}` - è·å–Shipå®¹å™¨æ—¥å¿—
- `POST /ship/{ship_id}/extend-ttl` - å»¶é•¿Shipç”Ÿå‘½å‘¨æœŸ

### å¥åº·æ£€æŸ¥

- `GET /health` - æœåŠ¡å¥åº·æ£€æŸ¥
- `GET /` - æ ¹ç«¯ç‚¹

## ç¯å¢ƒå˜é‡

å‚è€ƒ `.env.example` æ–‡ä»¶äº†è§£æ‰€æœ‰å¯é…ç½®çš„ç¯å¢ƒå˜é‡ã€‚

ä¸»è¦é…ç½®é¡¹ï¼š

- `ACCESS_TOKEN`: APIè®¿é—®ä»¤ç‰Œ
- `DATABASE_URL`: SQLiteæ•°æ®åº“æ–‡ä»¶è·¯å¾„
- `MAX_SHIP_NUM`: æœ€å¤§Shipæ•°é‡
- `BEHAVIOR_AFTER_MAX_SHIP`: è¾¾åˆ°æœ€å¤§Shipæ•°é‡åçš„è¡Œä¸ºï¼ˆreject/waitï¼‰
- `CONTAINER_DRIVER`: å®¹å™¨è¿è¡Œæ—¶é©±åŠ¨ï¼ˆdocker/docker-host/podman/podman-host/kubernetesï¼Œé»˜è®¤docker-hostï¼‰
- `DOCKER_IMAGE`: Shipå®¹å™¨é•œåƒåç§°
- `SHIP_CONTAINER_PORT`: Shipå®¹å™¨å†…éƒ¨ç«¯å£ï¼ˆé»˜è®¤8123ï¼‰
- `SHIP_HEALTH_CHECK_TIMEOUT`: Shipå¥åº·æ£€æŸ¥æœ€å¤§è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤60ï¼‰
- `SHIP_HEALTH_CHECK_INTERVAL`: Shipå¥åº·æ£€æŸ¥é—´éš”æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤2ï¼‰
- `DOCKER_NETWORK`: Dockerç½‘ç»œåç§°

### Kubernetes ä¸“ç”¨é…ç½®

- `KUBE_NAMESPACE`: Kubernetes å‘½åç©ºé—´ï¼ˆé»˜è®¤è¯»å– in-cluster é…ç½®æˆ– defaultï¼‰
- `KUBE_CONFIG_PATH`: Kubeconfig æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ in-cluster é…ç½®ï¼‰
- `KUBE_IMAGE_PULL_POLICY`: é•œåƒæ‹‰å–ç­–ç•¥ï¼ˆé»˜è®¤ IfNotPresentï¼‰
- `KUBE_PVC_SIZE`: æ¯ä¸ª Ship çš„ PVC å¤§å°ï¼ˆé»˜è®¤ 1Giï¼‰
- `KUBE_STORAGE_CLASS`: PVC çš„ StorageClassï¼ˆå¯é€‰ï¼Œä½¿ç”¨é›†ç¾¤é»˜è®¤ï¼‰

**æ³¨æ„**: åœ¨é…ç½®èµ„æºé™åˆ¶æ—¶ï¼ˆå¦‚é€šè¿‡ API è¯·æ±‚ï¼‰ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨æ­£ç¡®çš„ Kubernetes å•ä½ï¼š
- å†…å­˜ï¼šä½¿ç”¨ `Mi` (Mebibytes) æˆ– `Gi` (Gibibytes)ã€‚ä¾‹å¦‚ `512Mi`ã€‚
- **è­¦å‘Š**: ä¸è¦ä½¿ç”¨ `m` ä½œä¸ºå†…å­˜å•ä½ï¼ˆå¦‚ `512m`ï¼‰ï¼Œè¿™åœ¨ Kubernetes ä¸­è¡¨ç¤º "milli-bytes"ï¼ˆåƒåˆ†ä¹‹ä¸€å­—èŠ‚ï¼‰ï¼Œä¼šå¯¼è‡´å®¹å™¨åˆ›å»ºå¤±è´¥ä¸”æŠ¥é”™ä¿¡æ¯ï¼ˆå¦‚ `no space left on device`ï¼‰æå…·è¯¯å¯¼æ€§ã€‚

## å®¹å™¨é©±åŠ¨æ¶æ„

Bay ä½¿ç”¨å¯æ’æ‹”çš„é©±åŠ¨æ¶æ„æ¥æ”¯æŒä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶å’Œéƒ¨ç½²æ¨¡å¼ï¼š

### æ”¯æŒçš„é©±åŠ¨

| é©±åŠ¨ | çŠ¶æ€ | è¯´æ˜ | ç½‘ç»œæ¨¡å¼ |
|------|------|------|----------|
| **docker** | âœ… å¯ç”¨ | Bay è¿è¡Œåœ¨ Docker å®¹å™¨å†… | ä½¿ç”¨å®¹å™¨å†…éƒ¨IP (å¦‚ `172.18.0.2:8123`) |
| **docker-host** | âœ… å¯ç”¨ (é»˜è®¤) | Bay è¿è¡Œåœ¨å®¿ä¸»æœºä¸Š | ä½¿ç”¨ localhost + ç«¯å£æ˜ å°„ (å¦‚ `127.0.0.1:39314`) |
| **podman** | âœ… å¯ç”¨ | Bay è¿è¡Œåœ¨ Podman å®¹å™¨å†… | ä½¿ç”¨å®¹å™¨å†…éƒ¨IP |
| **podman-host** | âœ… å¯ç”¨ | Bay è¿è¡Œåœ¨å®¿ä¸»æœºä¸Š (Podman) | ä½¿ç”¨ localhost + ç«¯å£æ˜ å°„ |
| **kubernetes** | âœ… å¯ç”¨ | Bay è¿è¡Œåœ¨ Kubernetes é›†ç¾¤å†… | ä½¿ç”¨ Pod IP + PVC æŒä¹…åŒ–å­˜å‚¨ |
| **containerd** | ğŸš§ è®¡åˆ’ä¸­ | ä½¿ç”¨ containerd è¿è¡Œæ—¶ | - |

### é€‰æ‹©æ­£ç¡®çš„é©±åŠ¨

- **docker-host** (æ¨è): å½“ Bay ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šæ—¶ä½¿ç”¨ã€‚è¿™ç§æ¨¡å¼é€šè¿‡ç«¯å£æ˜ å°„è®¿é—® Ship å®¹å™¨ï¼Œè§£å†³äº†å®¿ä¸»æœºæ— æ³•ç›´æ¥è®¿é—®å®¹å™¨å†…éƒ¨ IP çš„é—®é¢˜ã€‚

- **docker**: å½“ Bay è¿è¡Œåœ¨ Docker å®¹å™¨å†…æ—¶ä½¿ç”¨ï¼ˆå¦‚é€šè¿‡ docker-compose éƒ¨ç½²ï¼‰ã€‚è¿™ç§æ¨¡å¼å¯ä»¥ç›´æ¥ä½¿ç”¨å®¹å™¨ç½‘ç»œ IP è¿›è¡Œé€šä¿¡ã€‚

### é©±åŠ¨æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Bay Service                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ShipService                                                    â”‚
â”‚    â”œâ”€â”€ url_builder.py    (æ„å»º Ship URLï¼Œå¤„ç†ä¸åŒåœ°å€æ ¼å¼)       â”‚
â”‚    â”œâ”€â”€ http_client.py    (HTTP é€šä¿¡ï¼šå¥åº·æ£€æŸ¥ã€execã€æ–‡ä»¶ä¼ è¾“)   â”‚
â”‚    â””â”€â”€ service.py        (Ship ç”Ÿå‘½å‘¨æœŸç®¡ç†)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ContainerDriver (æŠ½è±¡æ¥å£)                                      â”‚
â”‚    â”œâ”€â”€ DockerDriver       (å®¹å™¨å†…éƒ¨ç½²ï¼Œè¿”å›å®¹å™¨IP)               â”‚
â”‚    â”œâ”€â”€ DockerHostDriver   (å®¿ä¸»æœºéƒ¨ç½²ï¼Œè¿”å› localhost:port)      â”‚
â”‚    â”œâ”€â”€ ContainerdDriver   (è®¡åˆ’ä¸­)                              â”‚
â”‚    â””â”€â”€ PodmanDriver       (è®¡åˆ’ä¸­)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è‡ªå®šä¹‰é©±åŠ¨

è¦å®ç°è‡ªå®šä¹‰å®¹å™¨é©±åŠ¨ï¼Œéœ€è¦ï¼š

1. åœ¨ `app/drivers/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„é©±åŠ¨æ–‡ä»¶
2. ç»§æ‰¿ [`ContainerDriver`](app/drivers/base.py) æŠ½è±¡åŸºç±»
3. å®ç°æ‰€æœ‰å¿…éœ€çš„æ–¹æ³•ï¼š
   - `initialize()`: åˆå§‹åŒ–é©±åŠ¨è¿æ¥
   - `close()`: å…³é—­é©±åŠ¨è¿æ¥
   - `create_ship_container()`: åˆ›å»ºå®¹å™¨ï¼Œè¿”å› `ContainerInfo`
   - `stop_ship_container()`: åœæ­¢å¹¶åˆ é™¤å®¹å™¨
   - `ship_data_exists()`: æ£€æŸ¥æ•°æ®ç›®å½•æ˜¯å¦å­˜åœ¨
   - `get_container_logs()`: è·å–å®¹å™¨æ—¥å¿—
   - `is_container_running()`: æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€
4. åœ¨ [`factory.py`](app/drivers/factory.py) ä¸­æ³¨å†Œé©±åŠ¨

### ContainerInfo æ•°æ®ç»“æ„

é©±åŠ¨è¿”å›çš„å®¹å™¨ä¿¡æ¯å¿…é¡»ç¬¦åˆ `ContainerInfo` æ¨¡å‹ï¼š

```python
@dataclass
class ContainerInfo:
    container_id: str       # å®¹å™¨ ID
    ip_address: str         # è®¿é—®åœ°å€ (IP æˆ– IP:port)
```

**æ³¨æ„**: `ip_address` å­—æ®µçš„æ ¼å¼å–å†³äºé©±åŠ¨ç±»å‹ï¼š
- `docker` é©±åŠ¨: è¿”å›çº¯ IP åœ°å€ï¼Œå¦‚ `172.18.0.2`
- `docker-host` é©±åŠ¨: è¿”å› `IP:port` æ ¼å¼ï¼Œå¦‚ `127.0.0.1:39314`

## å¼€å‘

### ä»£ç æ ¼å¼åŒ–

ä½¿ç”¨ `ruff`:

```bash
ruff format app/
ruff check app/
```

### ç±»å‹æ£€æŸ¥

ä½¿ç”¨mypyï¼š

```bash
mypy app/
```

### æµ‹è¯•

```bash
pytest
```

### æ•°æ®åº“è¿ç§»

åˆ›å»ºæ–°çš„è¿ç§»ï¼š

```bash
alembic revision --autogenerate -m "description"
```

åº”ç”¨è¿ç§»ï¼š

```bash
alembic upgrade head
```
